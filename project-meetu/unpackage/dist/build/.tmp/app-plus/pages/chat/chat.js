(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"0e3d":function(t,e,n){"use strict";(function(t,o){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=n("2f62"),i=l(n("a115")),s=n("db78"),r=c(n("c478"));function c(t){return t&&t.__esModule?t:{default:t}}function l(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(t,n):{};o.get||o.set?Object.defineProperty(e,n,o):e[n]=t[n]}return e.default=t,e}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},o=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(e){f(t,e,n[e])})}return t}function f(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var h=function(){return n.e("components/mix-pulldown-refresh/mix-pulldown-refresh").then(n.bind(null,"7eee"))},d=t.createInnerAudioContext();d.autoplay=!0;var m={name:"chat",mixins:[r.default],components:{mixPulldownRefresh:h},data:function(){return{chatUserInfo:null,style:{contentViewHeight:0,mitemHeight:0,scrollViewMarginTop:t.upx2px(30)},scrollTop:0,scrollToView:"",SoftKeyboardHeight:0,textareaValue:"",prevImgArr:[],page:null,lastInfoTime:null,againCurrIndex:!1,audioPlay:!1,audioPlayCur:-1,enableScroll:!0}},computed:u({},(0,a.mapGetters)(["userInfo","token"]),(0,a.mapState)({WS:function(t){return t.socketInfo.WS},chatInfoList:function(t){return t.socketInfo.chatInfo},chatMsg:function(t){return t.socketInfo.chatMsg},chatMsgErr:function(t){return t.socketInfo.chatMsgErr}})),watch:{chatMsg:function(t,e){var n=this,o=this;o.lastInfoTime=o.lastInfoTime?o.lastInfoTime:o.chatInfoList[o.chatInfoList.length-1].created_at,(t.from_id==o.chatUserInfo.user_id&&t.user_id==o.userInfo.id||t.from_id==o.userInfo.id&&t.user_id==o.chatUserInfo.user_id)&&(this.chatInfoList.push({id:t.id,user_id:t.user_id,nickname:t.nickname,headimgurl:t.headimgurl,type:t.type,content:t.content,created_at:t.created_at,created_at_format:i.timeFormat(t.created_at),is_show_time:i.dateDiff(o.lastInfoTime,t.created_at)}),this.ws_read(this.chatUserInfo.user_id),setTimeout(function(){n.scrollToBottom(),n.lastInfoTime=t.created_at},10))},chatInfoList:function(t,e){this.page=this.page&&this.page<1?0:t[0].page-1,this.$refs.mixPulldownRefresh&&this.$refs.mixPulldownRefresh.endPulldownRefresh();for(var n=0;n<t.length;n++)3==t[n].type&&this.prevImgArr.push(t[n].content)},chatMsgErr:function(t,e){if("chatMsg"==t.msgType)switch(t.error){case 0:if(this.againCurrIndex){var n=i.dateFormat(new Date,"yyyy.MM.dd hh:mm:ss");self.chatInfoList[self.againCurrIndex].send_err=!1,self.chatInfoList[self.againCurrIndex].created_at=n,self.chatInfoList[self.againCurrIndex].created_at_format=i.timeFormat(n),self.chatInfoList[self.againCurrIndex].is_show_time=i.dateDiff(self.lastInfoTime,n)}this.lastInfoTime=this.chatInfoList[this.chatInfoList.length-1].created_at;break;case 1:this.modalShow("toastModal",t.error+t.error_msg),this.chatInfoList[this.chatInfoList.length-1].send_err=!0;break;case 2:this.modalShow("dialogModal",t.error+t.error_msg),this.dialogSureText="星豆充值",this.chatInfoList[this.chatInfoList.length-1].send_err=!0;break}}},onLoad:function(t){var e=this;d.onEnded(function(){e.audioPlay=!1,e.audioPlayCur=-1}),this.chatUserInfo=JSON.parse(t.chatItem),this.ws_GetChatLogInfo()},onShow:function(){var e=this,n=t.getSystemInfoSync();this.style.contentViewHeight=n.windowHeight-n.screenWidth/750*100-this.CustomBar-this.style.scrollViewMarginTop,setTimeout(function(){e.scrollToBottom()},500)},methods:{ws_GetChatLogInfo:function(t){var e=this;if(t&&"add"==t&&0==this.page)return this.$refs.mixPulldownRefresh&&this.$refs.mixPulldownRefresh.endPulldownRefresh(),!1;this.WS.sendSocketMessage({msgType:"getChatLogInfo",data:{page:e.page,user_id:e.chatUserInfo.user_id}},function(t){})},ws_sendMsg:function(t,e){var n=this,a=this,s=i.dateFormat(new Date,"yyyy.MM.dd hh:mm:ss");a.lastInfoTime=a.lastInfoTime?a.lastInfoTime:a.chatInfoList[a.chatInfoList.length-1].created_at,console.log(o("------最后一条消息时间-----",a.lastInfoTime," at pages\\chat\\chat.vue:231")),console.log(o("------发送消息时间-----",s," at pages\\chat\\chat.vue:232"));var r={id:a.chatInfoList[a.chatInfoList.length-1].id+1,user_id:a.userInfo.id,nickname:a.userInfo.nickname,headimgurl:a.userInfo.headimgurl,type:t,content:e,created_at:s,created_at_format:i.timeFormat(s),is_show_time:i.dateDiff(a.lastInfoTime,s)};this.WS.sendSocketMessage({msgType:"chatMsg",data:{to_id:a.chatUserInfo.user_id,content_type:t,content:e}},function(t){n.textareaValue&&(console.log(o(n.textareaValue," at pages\\chat\\chat.vue:255")),n.textareaValue=""),a.chatInfoList.push(r),setTimeout(function(){a.scrollToBottom()},10)},function(t){})},ws_read:function(t){this.WS.sendSocketMessage({msgType:"read",data:{user_id:t}},function(t){})},onPulldownReresh:(0,s.throttle)(function(){var t=this;t.loadHistoryChatInfo()},2e3,function(){var t=this;t.$refs.mixPulldownRefresh&&t.$refs.mixPulldownRefresh.endPulldownRefresh()}),setEnableScroll:function(t){this.enableScroll!==t&&(this.enableScroll=t)},loadHistoryChatInfo:function(){this.ws_GetChatLogInfo("add")},scrollToBottom:function(){var e=this,n=t.createSelectorQuery();n.selectAll(".cu-item").boundingClientRect(),n.select(".panel-scroll-chat-view").boundingClientRect(),n.exec(function(t){e.style.mitemHeight=0,t[0].forEach(function(t){return e.style.mitemHeight=e.style.mitemHeight+t.height}),setTimeout(function(){e.style.mitemHeight>e.style.contentViewHeight&&(e.scrollTop=e.style.mitemHeight-e.style.contentViewHeight,console.log(o("scrollTop",e.scrollTop," at pages\\chat\\chat.vue:316")))},10)})},TextareaFocus:function(t){var e=this;e.softKeyboardHeightHandle("up",t.detail.height),setTimeout(function(){e.scrollToView="chat-item"+e.chatInfoList[e.chatInfoList.length-1].id},10)},TextareaInput:function(t){this.textareaValue=t.detail.value},TextareaBulr:function(){var t=this;t.softKeyboardHeightHandle("down",t.SoftKeyboardHeight)},softKeyboardHeightHandle:function(t,e){"up"==t?this.SoftKeyboardHeight=e:"down"==t&&(this.SoftKeyboardHeight=0)},previmg:function(e){var n=this;t.previewImage({current:e,urls:n.prevImgArr})},getUid:function(t){return t.substring(t.indexOf("/")+1,t.lastIndexOf("."))},chooseImg:function(){var e=this;t.chooseImage({count:1,sizeType:["compressed "],sourceType:["album ","camera "],success:function(n){console.log(o(n," at pages\\chat\\chat.vue:369"));var a=n.tempFilePaths[0];plus.zip.compressImage({src:a,dst:"_doc/"+e.getUid(a)+".jpg",overwrite:!0,quality:20},function(n){t.uploadFile({url:"https://api.meetu.letwx.com/v2/sys/upload-img?token="+e.token,filePath:a,name:"imgfile",formData:{name:"imgfile",formData:JSON.stringify({sort:0})},success:function(t){var n=JSON.parse(t.data).data.imgUrl;e.ws_sendMsg(3,n)},fail:function(t){console.log(o("err",t," at pages\\chat\\chat.vue:394"))}})},function(t){console.log(o("plus-error",t," at pages\\chat\\chat.vue:399"))})}})},playVoiceHandle:function(t){this.audioPlay?(d.pause(),this.audioPlay=!1):t.content&&(d.src=t.content,d.play(),this.audioPlay=!0,this.audioPlayCur=t.id)},stopVoiceHandle:function(){d.paused||d.stop(),d.src="",this.audioPlay=!1,this.audioPlayCur=-1},hideModal:function(){"dialogModal"==this.modalName&&(this.modalName="")},dialogConfirm:function(){this.modalName="",t.navigateTo({url:"../user/coin",animationDuration:300,animationType:"fade-in"})},submit:function(){return!!this.textareaValue&&(this.userInfo.totalpoints<=0?(this.modalShow("dialogModal","星豆不足"),this.dialogSureText="星豆充值",!1):void this.ws_sendMsg(1,this.textareaValue))},againSend:function(t,e){if(this.userInfo.totalpoints<=0)return this.modalShow("dialogModal","星豆不足"),this.dialogSureText="星豆充值",!1;this.againCurrIndex=e,this.ws_sendMsg(t.type,t.content)}},onHide:function(){this.stopVoiceHandle(),console.log(o("-----onHide--------"," at pages\\chat\\chat.vue:468"))},onUnload:function(){this.$store.commit("emptyInfo","chatInfo"),this.stopVoiceHandle(),console.log(o("-----onUnload--------"," at pages\\chat\\chat.vue:473"))}};e.default=m}).call(this,n("6e42")["default"],n("0de9")["default"])},"14b6":function(t,e,n){},"383c":function(t,e,n){"use strict";(function(t){n("e1e3"),n("921b");o(n("66fd"));var e=o(n("4436"));function o(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,n("6e42")["createPage"])},4436:function(t,e,n){"use strict";n.r(e);var o=n("7e37"),a=n("9a16");for(var i in a)"default"!==i&&function(t){n.d(e,t,function(){return a[t]})}(i);n("dfd1");var s=n("2877"),r=Object(s["a"])(a["default"],o["a"],o["b"],!1,null,null,null);e["default"]=r.exports},"7e37":function(t,e,n){"use strict";var o=function(){var t=this,e=t.$createElement;t._self._c},a=[];n.d(e,"a",function(){return o}),n.d(e,"b",function(){return a})},"9a16":function(t,e,n){"use strict";n.r(e);var o=n("0e3d"),a=n.n(o);for(var i in o)"default"!==i&&function(t){n.d(e,t,function(){return o[t]})}(i);e["default"]=a.a},dfd1:function(t,e,n){"use strict";var o=n("14b6"),a=n.n(o);a.a}},[["383c","common/runtime","common/vendor"]]]);