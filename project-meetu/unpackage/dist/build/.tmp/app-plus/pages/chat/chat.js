(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"0e3d":function(t,e,o){"use strict";(function(t,n){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=o("2f62"),i=r(o("a115")),s=c(o("c478"));function c(t){return t&&t.__esModule?t:{default:t}}function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(t,o):{};n.get||n.set?Object.defineProperty(e,o,n):e[o]=t[o]}return e.default=t,e}function u(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{},n=Object.keys(o);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(t){return Object.getOwnPropertyDescriptor(o,t).enumerable}))),n.forEach(function(e){l(t,e,o[e])})}return t}function l(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var f=getApp().globalData.socket,h=t.createInnerAudioContext();h.autoplay=!0;var d={name:"chat",mixins:[s.default],data:function(){return{chatUserInfo:null,style:{contentViewHeight:0,mitemHeight:0,scrollViewMarginTop:t.upx2px(30)},scrollTop:0,scrollToView:"",SoftKeyboardHeight:0,textareaValue:"",isFocus:!1,submitInputDisable:!0,isHistoryLoad:!1,prevImgArr:[],page:null,lastInfoTime:null,audioPlay:!1,audioPlayCur:-1}},computed:u({},(0,a.mapGetters)(["userInfo","token"]),(0,a.mapState)({chatInfoList:function(t){return t.socketInfo.chatInfo},chatMsg:function(t){return t.socketInfo.chatMsg}})),watch:{chatMsg:function(t,e){var o=this,n=this;this.chatInfoList.push({id:t.id,user_id:t.user_id,nickname:t.nickname,headimgurl:t.headimgurl,type:t.type,content:t.content,created_at:t.created_at,created_at_format:i.timeFormat(t.created_at),is_show_time:i.dateDiff(n.lastInfoTime,t.created_at)}),this.ws_read(this.chatUserInfo.user_id),setTimeout(function(){o.scrollToBottom(),o.lastInfoTime=t.created_at},10)},chatInfoList:function(t,e){this.page=this.page&&this.page<1?0:t[0].page-1;for(var o=0;o<t.length;o++)3==t[o].type&&this.prevImgArr.push(t[o].content)}},onLoad:function(t){var e=this;h.onEnded(function(){console.log(n("播放结束"," at pages\\chat\\chat.vue:147")),e.audioPlay=!1,e.audioPlayCur=-1}),this.chatUserInfo=JSON.parse(t.chatItem),this.clog("对话人",this.chatUserInfo),this.ws_GetChatLogInfo()},onReady:function(){this.lastInfoTime=this.chatInfoList[this.chatInfoList.length-1].created_at},onShow:function(){var e=this,o=t.getSystemInfoSync();this.style.contentViewHeight=o.windowHeight-o.screenWidth/750*100-this.CustomBar-this.style.scrollViewMarginTop,setTimeout(function(){e.scrollToBottom()},1e3)},methods:{ws_GetChatLogInfo:function(t){var e=this,o=this;if(t&&"add"==t){if(console.log(n("add被点击",o.page," at pages\\chat\\chat.vue:171")),0==this.page)return!1;if(this.isHistoryLoad)return!1;this.isHistoryLoad=!0}f.sendSocketMessage({msgType:"getChatLogInfo",data:{page:o.page,user_id:o.chatUserInfo.user_id}},function(o){t&&"add"==t&&setTimeout(function(){e.isHistoryLoad=!1},200)})},ws_sendMsg:function(t,e){var o=this,a=this,s=i.dateFormat(new Date,"yyyy.MM.dd hh:mm:ss"),c={id:a.chatInfoList[a.chatInfoList.length-1].id+1,user_id:a.userInfo.id,nickname:a.userInfo.nickname,headimgurl:a.userInfo.headimgurl,type:t,content:e,created_at:s,created_at_format:i.timeFormat(s),is_show_time:i.dateDiff(a.lastInfoTime,s)};f.sendSocketMessage({msgType:"chatMsg",data:{to_id:a.chatUserInfo.user_id,content_type:t,content:e}},function(t){a.clog("---聊天消息发送OK----",t),o.textareaValue&&(console.log(n(o.textareaValue," at pages\\chat\\chat.vue:226")),o.textareaValue=""),a.chatInfoList.push(c),setTimeout(function(){a.scrollToBottom(),a.lastInfoTime=s},10)},function(t){a.clog("---聊天消息发送ERR----",t)})},ws_read:function(t){var e=this;f.sendSocketMessage({msgType:"read",data:{user_id:t}},function(t){e.clog("----读取未读消息OK----",t)})},loadHistoryChatInfo:function(){this.ws_GetChatLogInfo("add")},scrollToBottom:function(){var e=this,o=t.createSelectorQuery();o.selectAll(".cu-item").boundingClientRect(),o.select(".panel-scroll-chat-view").boundingClientRect(),o.exec(function(t){e.style.mitemHeight=0,t[0].forEach(function(t){return e.style.mitemHeight=e.style.mitemHeight+t.height}),setTimeout(function(){e.style.mitemHeight>e.style.contentViewHeight&&(e.scrollTop=e.style.mitemHeight-e.style.contentViewHeight,console.log(n("scrollTop",e.scrollTop," at pages\\chat\\chat.vue:268")))},10)})},TextareaFocus:function(t){this.submitInputDisable=!1,this.softKeyboardHeightHandle("up",t.detail.height);var e=this;setTimeout(function(){e.scrollToView="chat-item"+e.chatInfoList[e.chatInfoList.length-1].id},10)},TextareaInput:function(t){this.textareaValue=t.detail.value},TextareaBulr:function(){var t=this;t.softKeyboardHeightHandle("down",t.SoftKeyboardHeight),setTimeout(function(){t.scrollToBottom()},10)},InputBlur:function(t){var e=this;e.isFocus=!1,this.submitInputDisable=!0,e.softKeyboardHeightHandle("down",e.SoftKeyboardHeight),setTimeout(function(){e.scrollToBottom()},10)},softKeyboardHeightHandle:function(t,e){"up"==t?(this.style.contentViewHeight-=e,this.SoftKeyboardHeight=e):"down"==t&&(this.style.contentViewHeight+=e,this.SoftKeyboardHeight=0)},previmg:function(e){var o=this;t.previewImage({current:e,urls:o.prevImgArr})},chooseImg:function(){var e=this;t.chooseImage({count:1,sizeType:["compressed "],sourceType:["album ","camera "],success:function(o){console.log(n(o," at pages\\chat\\chat.vue:335"));var a=o.tempFilePaths[0];t.uploadFile({url:"https://api.meetu.letwx.com/v2/sys/upload-img?token="+e.token,filePath:a,name:"imgfile",formData:{name:"imgfile",formData:JSON.stringify({sort:0})},success:function(t){var o=JSON.parse(t.data).data.imgUrl;e.ws_sendMsg(3,o)},fail:function(t){console.log(n("err",t," at pages\\chat\\chat.vue:353"))}})}})},playVoiceHandle:function(t){this.audioPlay?(h.pause(),this.audioPlay=!1):t.content&&(h.src=t.content,h.play(),this.audioPlay=!0,this.audioPlayCur=t.id)},stopVoiceHandle:function(){h.paused||h.stop(),h.src="",this.audioPlay=!1,this.audioPlayCur=-1},submit:function(){if(this.isFocus=!0,!this.textareaValue)return!1;this.ws_sendMsg(1,this.textareaValue)}},onHide:function(){this.InputBlur(),this.stopVoiceHandle(),console.log(n("-----onHide--------"," at pages\\chat\\chat.vue:396"))},onUnload:function(){this.$store.commit("emptyInfo","chatInfo"),this.stopVoiceHandle(),console.log(n("-----onUnload--------"," at pages\\chat\\chat.vue:401"))}};e.default=d}).call(this,o("6e42")["default"],o("0de9")["default"])},"14b6":function(t,e,o){},"383c":function(t,e,o){"use strict";(function(t){o("e1e3"),o("921b");n(o("66fd"));var e=n(o("4436"));function n(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,o("6e42")["createPage"])},4436:function(t,e,o){"use strict";o.r(e);var n=o("d354"),a=o("9a16");for(var i in a)"default"!==i&&function(t){o.d(e,t,function(){return a[t]})}(i);o("dfd1");var s=o("2877"),c=Object(s["a"])(a["default"],n["a"],n["b"],!1,null,null,null);e["default"]=c.exports},"9a16":function(t,e,o){"use strict";o.r(e);var n=o("0e3d"),a=o.n(n);for(var i in n)"default"!==i&&function(t){o.d(e,t,function(){return n[t]})}(i);e["default"]=a.a},d354:function(t,e,o){"use strict";var n=function(){var t=this,e=t.$createElement;t._self._c},a=[];o.d(e,"a",function(){return n}),o.d(e,"b",function(){return a})},dfd1:function(t,e,o){"use strict";var n=o("14b6"),a=o.n(n);a.a}},[["383c","common/runtime","common/vendor"]]]);