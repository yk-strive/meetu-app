(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"0e3d":function(t,e,o){"use strict";(function(t,a){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=o("2f62"),i=c(o("a115")),s=r(o("c478"));function r(t){return t&&t.__esModule?t:{default:t}}function c(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o)){var a=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(t,o):{};a.get||a.set?Object.defineProperty(e,o,a):e[o]=t[o]}return e.default=t,e}function u(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{},a=Object.keys(o);"function"===typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(o).filter(function(t){return Object.getOwnPropertyDescriptor(o,t).enumerable}))),a.forEach(function(e){l(t,e,o[e])})}return t}function l(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var f=t.createInnerAudioContext();f.autoplay=!0;var h={name:"chat",mixins:[s.default],data:function(){return{chatUserInfo:null,style:{contentViewHeight:0,mitemHeight:0,scrollViewMarginTop:t.upx2px(30)},scrollTop:0,scrollToView:"",SoftKeyboardHeight:0,textareaValue:"",isFocus:!1,submitInputDisable:!0,isHistoryLoad:!1,prevImgArr:[],page:null,lastInfoTime:null,againCurrIndex:0,audioPlay:!1,audioPlayCur:-1}},computed:u({},(0,n.mapGetters)(["userInfo","token"]),(0,n.mapState)({WS:function(t){return t.socketInfo.WS},chatInfoList:function(t){return t.socketInfo.chatInfo},chatMsg:function(t){return t.socketInfo.chatMsg},chatMsgErr:function(t){return t.socketInfo.chatMsgErr}})),watch:{chatMsg:function(t,e){var o=this,a=this;a.lastInfoTime=a.lastInfoTime?a.lastInfoTime:a.chatInfoList[a.chatInfoList.length-1].created_at,(t.from_id==a.chatUserInfo.user_id&&t.user_id==a.userInfo.id||t.from_id==a.userInfo.id&&t.user_id==a.chatUserInfo.user_id)&&(this.chatInfoList.push({id:t.id,user_id:t.user_id,nickname:t.nickname,headimgurl:t.headimgurl,type:t.type,content:t.content,created_at:t.created_at,created_at_format:i.timeFormat(t.created_at),is_show_time:i.dateDiff(a.lastInfoTime,t.created_at)}),this.ws_read(this.chatUserInfo.user_id),setTimeout(function(){o.scrollToBottom(),o.lastInfoTime=t.created_at},10))},chatInfoList:function(t,e){this.page=this.page&&this.page<1?0:t[0].page-1;for(var o=0;o<t.length;o++)3==t[o].type&&this.prevImgArr.push(t[o].content)},chatMsgErr:function(t,e){if("chatMsg"==t.msgType)switch(t.error){case 1:this.modalShow("toastModal",t.error+t.error_msg),this.chatInfoList[this.chatInfoList.length-1].send_err=!0;break;case 2:this.modalShow("dialogModal",t.error+t.error_msg),this.dialogSureText="星豆充值",this.chatInfoList[this.chatInfoList.length-1].send_err=!0;break;default:this.modalShow("toastModal",t.error+t.error_msg);break}}},onLoad:function(t){var e=this;f.onEnded(function(){e.audioPlay=!1,e.audioPlayCur=-1}),this.chatUserInfo=JSON.parse(t.chatItem),this.ws_GetChatLogInfo()},onShow:function(){var e=this,o=t.getSystemInfoSync();this.style.contentViewHeight=o.windowHeight-o.screenWidth/750*100-this.CustomBar-this.style.scrollViewMarginTop,setTimeout(function(){e.scrollToBottom()},1e3)},methods:{ws_GetChatLogInfo:function(t){var e=this,o=this;if(t&&"add"==t){if(console.log(a("add被点击",o.page," at pages\\chat\\chat.vue:194")),0==this.page)return!1;if(this.isHistoryLoad)return!1;this.isHistoryLoad=!0}this.WS.sendSocketMessage({msgType:"getChatLogInfo",data:{page:o.page,user_id:o.chatUserInfo.user_id}},function(o){t&&"add"==t&&setTimeout(function(){e.isHistoryLoad=!1},200)})},ws_sendMsg:function(t,e,o){var n=this,s=this,r=i.dateFormat(new Date,"yyyy.MM.dd hh:mm:ss");s.lastInfoTime=s.lastInfoTime?s.lastInfoTime:s.chatInfoList[s.chatInfoList.length-1].created_at,console.log(a("------最后一条消息时间-----",s.lastInfoTime," at pages\\chat\\chat.vue:230")),console.log(a("------发送消息时间-----",r," at pages\\chat\\chat.vue:231"));var c={id:s.chatInfoList[s.chatInfoList.length-1].id+1,user_id:s.userInfo.id,nickname:s.userInfo.nickname,headimgurl:s.userInfo.headimgurl,type:t,content:e,created_at:r,created_at_format:i.timeFormat(r),is_show_time:i.dateDiff(s.lastInfoTime,r)};this.WS.sendSocketMessage({msgType:"chatMsg",data:{to_id:s.chatUserInfo.user_id,content_type:t,content:e}},function(t){s.clog("---聊天消息发送OK----",t),n.textareaValue&&(console.log(a(n.textareaValue," at pages\\chat\\chat.vue:254")),n.textareaValue=""),o?(s.chatInfoList[s.againCurrIndex].send_err=!1,s.chatInfoList[s.againCurrIndex].created_at=r,s.chatInfoList[s.againCurrIndex].created_at_format=i.timeFormat(r),s.chatInfoList[s.againCurrIndex].is_show_time=i.dateDiff(s.lastInfoTime,r)):s.chatInfoList.push(c),setTimeout(function(){s.scrollToBottom(),s.lastInfoTime=r},10)},function(t){s.clog("---聊天消息发送ERR----",t)})},ws_read:function(t){var e=this;this.WS.sendSocketMessage({msgType:"read",data:{user_id:t}},function(t){e.clog("----读取未读消息OK----",t)})},loadHistoryChatInfo:function(){this.ws_GetChatLogInfo("add")},scrollToBottom:function(){var e=this,o=t.createSelectorQuery();o.selectAll(".cu-item").boundingClientRect(),o.select(".panel-scroll-chat-view").boundingClientRect(),o.exec(function(t){e.style.mitemHeight=0,t[0].forEach(function(t){return e.style.mitemHeight=e.style.mitemHeight+t.height}),setTimeout(function(){e.style.mitemHeight>e.style.contentViewHeight&&(e.scrollTop=e.style.mitemHeight-e.style.contentViewHeight,console.log(a("scrollTop",e.scrollTop," at pages\\chat\\chat.vue:307")))},10)})},TextareaFocus:function(t){this.submitInputDisable=!1,this.softKeyboardHeightHandle("up",t.detail.height);var e=this;setTimeout(function(){e.scrollToView="chat-item"+e.chatInfoList[e.chatInfoList.length-1].id},10)},TextareaInput:function(t){this.textareaValue=t.detail.value},TextareaBulr:function(){var t=this;t.softKeyboardHeightHandle("down",t.SoftKeyboardHeight),setTimeout(function(){t.scrollToBottom()},10)},InputBlur:function(t){var e=this;e.isFocus=!1,this.submitInputDisable=!0,e.softKeyboardHeightHandle("down",e.SoftKeyboardHeight),setTimeout(function(){e.scrollToBottom()},10)},softKeyboardHeightHandle:function(t,e){"up"==t?this.SoftKeyboardHeight=e:"down"==t&&(this.SoftKeyboardHeight=0)},previmg:function(e){var o=this;t.previewImage({current:e,urls:o.prevImgArr})},chooseImg:function(){var e=this;t.chooseImage({count:1,sizeType:["compressed "],sourceType:["album ","camera "],success:function(o){console.log(a(o," at pages\\chat\\chat.vue:374"));var n=o.tempFilePaths[0];t.uploadFile({url:"https://api.meetu.letwx.com/v2/sys/upload-img?token="+e.token,filePath:n,name:"imgfile",formData:{name:"imgfile",formData:JSON.stringify({sort:0})},success:function(t){var o=JSON.parse(t.data).data.imgUrl;e.ws_sendMsg(3,o)},fail:function(t){console.log(a("err",t," at pages\\chat\\chat.vue:392"))}})}})},playVoiceHandle:function(t){this.audioPlay?(f.pause(),this.audioPlay=!1):t.content&&(f.src=t.content,f.play(),this.audioPlay=!0,this.audioPlayCur=t.id)},stopVoiceHandle:function(){f.paused||f.stop(),f.src="",this.audioPlay=!1,this.audioPlayCur=-1},hideModal:function(){"dialogModal"==this.modalName&&(this.modalName="")},dialogConfirm:function(){this.modalName="",t.navigateTo({url:"../user/coin",animationDuration:300,animationType:"fade-in"})},submit:function(){if(this.isFocus=!0,!this.textareaValue)return!1;this.ws_sendMsg(1,this.textareaValue)},againSend:function(t,e){this.againCurrIndex=e,this.ws_sendMsg(t.type,t.content,1)}},onHide:function(){this.InputBlur(),this.stopVoiceHandle(),console.log(a("-----onHide--------"," at pages\\chat\\chat.vue:465"))},onUnload:function(){this.$store.commit("emptyInfo","chatInfo"),this.stopVoiceHandle(),console.log(a("-----onUnload--------"," at pages\\chat\\chat.vue:470"))}};e.default=h}).call(this,o("6e42")["default"],o("0de9")["default"])},"14b6":function(t,e,o){},"383c":function(t,e,o){"use strict";(function(t){o("e1e3"),o("921b");a(o("66fd"));var e=a(o("4436"));function a(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,o("6e42")["createPage"])},4436:function(t,e,o){"use strict";o.r(e);var a=o("f651"),n=o("9a16");for(var i in n)"default"!==i&&function(t){o.d(e,t,function(){return n[t]})}(i);o("dfd1");var s=o("2877"),r=Object(s["a"])(n["default"],a["a"],a["b"],!1,null,null,null);e["default"]=r.exports},"9a16":function(t,e,o){"use strict";o.r(e);var a=o("0e3d"),n=o.n(a);for(var i in a)"default"!==i&&function(t){o.d(e,t,function(){return a[t]})}(i);e["default"]=n.a},dfd1:function(t,e,o){"use strict";var a=o("14b6"),n=o.n(a);n.a},f651:function(t,e,o){"use strict";var a=function(){var t=this,e=t.$createElement;t._self._c},n=[];o.d(e,"a",function(){return a}),o.d(e,"b",function(){return n})}},[["383c","common/runtime","common/vendor"]]]);